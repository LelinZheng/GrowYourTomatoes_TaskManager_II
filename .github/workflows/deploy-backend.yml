name: Deploy Backend to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend/tomato

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Build backend jar
        run: mvn -DskipTests clean package

      - name: Sync GitHub Actions IPs to EC2 SG (SSH allowlist)
        shell: bash
        env:
          SG_ID: ${{ secrets.EC2_SG_ID }}
        run: |
          set -euo pipefail

          echo "Fetching GitHub meta..."
          META_JSON="$(curl -fsSL https://api.github.com/meta)"

          NEW_CIDRS="$(echo "$META_JSON" | jq -r '.actions[]')"

          echo "GitHub Actions CIDRs:"
          echo "$NEW_CIDRS"

          echo "Reading current SG SSH(22) CIDRs..."
          CURRENT_CIDRS="$(aws ec2 describe-security-groups \
            --group-ids "$SG_ID" \
            --query "SecurityGroups[0].IpPermissions[?FromPort==\`22\` && ToPort==\`22\` && IpProtocol==\`tcp\`].IpRanges[].CidrIp" \
            --output text | tr '\t' '\n' | sort -u || true)"

          CURRENT_MARKED_CIDRS="$(aws ec2 describe-security-groups \
            --group-ids "$SG_ID" \
            --query "SecurityGroups[0].IpPermissions[?FromPort==\`22\` && ToPort==\`22\` && IpProtocol==\`tcp\`].IpRanges[?Description=='github-actions-ssh'].CidrIp" \
            --output text | tr '\t' '\n' | sort -u || true)"

          echo "Currently-marked CIDRs (managed by workflow):"
          echo "${CURRENT_MARKED_CIDRS:-<none>}"

          while read -r cidr; do
            [[ -z "$cidr" ]] && continue
            if ! echo "$NEW_CIDRS" | grep -qx "$cidr"; then
              echo "Revoking old CIDR: $cidr"
              aws ec2 revoke-security-group-ingress \
                --group-id "$SG_ID" \
                --ip-permissions "IpProtocol=tcp,FromPort=22,ToPort=22,IpRanges=[{CidrIp=$cidr,Description=github-actions-ssh}]"
            fi
          done <<< "${CURRENT_MARKED_CIDRS:-}"

          while read -r cidr; do
            [[ -z "$cidr" ]] && continue
            if ! echo "$CURRENT_CIDRS" | grep -qx "$cidr"; then
              echo "Authorizing new CIDR: $cidr"
              aws ec2 authorize-security-group-ingress \
                --group-id "$SG_ID" \
                --ip-permissions "IpProtocol=tcp,FromPort=22,ToPort=22,IpRanges=[{CidrIp=$cidr,Description=github-actions-ssh}]"
            else
              # CIDR already exists (maybe your old manual allowlist). We won't touch.
              echo "Already present: $cidr"
            fi
          done <<< "$NEW_CIDRS"

          echo "Done syncing SG allowlist."


      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Upload jar to EC2
        run: |
          scp target/*.jar \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/tomato/app/tomato.jar"

      - name: Restart backend service
        run: |
          ssh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" << 'EOF'
            sudo systemctl restart tomato
            sudo systemctl status tomato --no-pager -l
          EOF
